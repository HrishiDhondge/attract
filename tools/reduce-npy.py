"""Reduces a Numpy array of atomic coordinates (such as generated using dump_coordinates.py) using a reduce plan (as generated by reduce-plan.py)
"""
import sys
import numpy as np

def run(coordinates, plandata):
    nstruc = len(coordinates)
    if coordinates.ndim == 2:
        coordinates = coordinates.reshape(nstruc, -1, 3)
    lines = [l.strip() for l in plandata.splitlines() if len(l.strip())]
    indices = [[int(ll) - 1 for ll in l.split()] for l in lines]
    beads = len(indices)
    outp = np.zeros((nstruc, beads, 3))
    for n in range(beads):
        coors = coordinates[:, indices[n]]
        coors = coors.mean(axis=1)
        outp[:, n] = coors
    return outp


if __name__ == "__main__":
    npyfile = sys.argv[1]
    npy = np.load(npyfile)
    planfile = sys.argv[2]
    plandata = open(planfile).read()
    outpfile = sys.argv[3]
    outp = run(npy, plandata)
    np.save(outpfile, outp)